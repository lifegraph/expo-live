<!DOCTYPE html>

<html>
<body>
  <div class="container-fluid">
  <h2>Antfarm Debug</h2>
<b>Data:</b> <a href="/segments/?latest" class="btn">Current Segments</a>
<a href="/ants/" class="btn">Ants</a>
<a href="/colonies/" class="btn">Colonies</a>
<a href="/users/" class="btn">Users</a>
<a href="/locations/" class="btn">Locations</a>
<a href="/presentations/" class="btn">Presentations</a>

<hr>
<div id="results">
</div>

<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
<script src="http://code.jquery.com/jquery.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/olinexpo.js"></script>
<script>

var segments = {};

var api = olinexpo()
  .on('connect', function () {
    setInterval(refresh, 1000);
  })
  .listenAll(false, function (_, _segments) {
    segments = _segments;
  });

function readableTimedelta (s) {
  return (0|(s/3600)) + ' hours, ' + (0|((s % 3600)/60)) + ' minutes, ' + (0|((s%60))) + ' seconds'
}

function refresh () {
  $('#results').html('');
  segments.forEach(function (seg) {
    var start = seg.start, strstart = String(new Date(start)).split(/\s+/g).slice(0, 5).join(' ');
    var end = seg.end, strend = String(new Date(end)).split(/\s+/g).slice(0, 5).join(' ')
    var running_s = Math.round((end - start)/1000);
    var latest_s = Math.round((Date.now() - end)/1000);
    $('#results').append($(
      '<h3>Ant: ' + seg.ant + ' <small class="muted">' + 
        '<b>Start:</b>' + strstart +
        '&nbsp;&nbsp;&nbsp;<b>Latest:</b>' + strend + '</small> <a class="btn btn-mini btn-danger">Delete</a></h3>' +
      '<blockquote>' +
      '<i>time running:</i> ' + 
        readableTimedelta(running_s) + '<br>' +
      (latest_s > 10 ? '<span style="color: red">' : '') + '<i>time since latest:</i> ' +
        readableTimedelta(latest_s) +
      (latest_s > 10 ? '</span>' : '') +
      '</blockquote>').on('click', '.btn', function () {
        if (confirm('Are you sure you wanna delete these binds?')) {
          $.ajax({
            type: 'DELETE',
            url: '/binds/?ant=' + seg.ant,
            success: function (res, error) {
              console.log(error);
              window.location.reload();
            }
          });
        }
      }));
  });
}

</script>
</div>
</body>
</html>