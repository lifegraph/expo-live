<!DOCTYPE html>

<html>
  <head>
    <style>

.flash { background: yellow; }
.unflash { -webkit-transition: background 1s; }

    </style>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
  </head>
  <body>

<h1>Diagnostics Page</h1>

<h3>Ants</h3>
<ul id="ants"></ul>

<h3>Colonies</h3>
<ul id="colonies"></ul>

    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/olinexpo.js"></script>
    <script>

var ants = {}, colonies = {};

var api = olinexpo(function () {
  api._listenBinds(function (bind) {
    // ant row
    if (!$('#ants li[data-ant=' + JSON.stringify(bind.ant) + ']')[0]) {
      $('<li data-ant=' + JSON.stringify(bind.ant) + '><h4></h4><span>Time since last bind: <b></b></span></li>')
        .appendTo($('#ants'))
        .find('h4').text(bind.ant);
    }
    // colony row
    if (!$('#colonies li[data-ant=' + JSON.stringify(bind.ant) + ']')[0]) {
      $('<li data-colony=' + JSON.stringify(bind.ant) + '><h4></h4><span>Time since last bind: <b></b></span></li>')
        .appendTo($('#colonies'))
        .find('h4').text(bind.colony);
    }

    ants[bind.ant] = bind;
    colonies[bind.colony] = bind;
  })
});

function timesince (d) {
  var delta = (Date.now() - d) / 1000;
  var seconds = delta % 60;
  var minutes = (0|(delta / 60)) % 60;
  var hours = (0|(delta / 3600));
  var str = hours + ' hours, ' + minutes + ' minutes, ' + seconds + ' seconds';
  if (delta > 10) {
    str = '<span style="color: red">' + str + '</span>';
  }
  return str;
}

setInterval(function () {
  Object.keys(ants).forEach(function (antid) {
    var bind = ants[antid];
    $('#ants li[data-ant=' + JSON.stringify(antid) + ']')
      .addClass('flash')
      .find('b').html(timesince(bind.time));
  });

  Object.keys(colonies).forEach(function (colonyid) {
    var bind = colines[colonyid];
    $('#colonies li[data-colony=' + JSON.stringify(colonyid) + ']')
      .addClass('flash')
      .find('b').html(timesince(bind.time));
  });

  setTimeout(function () {
    $('.flash').removeClass('flash').addClass('unflash');
  }, 10);
}, 200);

    </script>
  </body>
</html>