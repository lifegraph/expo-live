<!DOCTYPE html>

<html>
  <head>
    <style>
    canvas { border: 1px solid red; }
    </style>
  </head>
  <body>
    <canvas id="canvas" width="1000" height="400">Lol</canvas>
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="/olinexpo.js"></script>
    <script>

// Static mapping locations to graphical positions.
// This needs to be fleshed out much more.
var locations = {
  "AC118": {x: -100, y: -25}
};

/**
 * Visual code
 */

var image_ac = new Image();
image_ac.src = 'ac1.png';

function Visual (width, height) {
  this.width = width;
  this.height = height;

  var canvas = document.getElementById('canvas');
  this.ctx = canvas.getContext('2d');
  this.ctx.translate(width/2, height/2);

  $(canvas).on('click', function (e) {
    this.ctx.fillStyle = 'blue';
    e.offsetX -= cwidth / 2;
    e.offsetY -= cheight / 2;
    drawMarker(this.ctx, e.offsetX, e.offsetY);
  }.bind(this));

  this.markers = {};

  setInterval(function () {
    Object.keys(this.markers).forEach(function (locid) {
      this.mark(locid, this.markers[locid] - 0.1);
    }.bind(this))
  }.bind(this), 50);
}d

Visual.prototype.resetMarkers = function () {
  delete this.markers;
  this.markers = {};
}

Visual.prototype.mark = function (id, amountToIncrease) {
  this.markers[id] = (this.markers[id] || 0) + amountToIncrease;
}

Visual.prototype.render = function () {
  this.ctx.drawImage(image_ac, -this.width/2, -this.height/2, this.width, this.height);
  Object.keys(this.markers).forEach(function (room) {
    var x = locations[room].x, y = locations[room].y, radius = this.markers[room];
    this.ctx.fillRect(x - radius, y - radius, radius * 2, radius * 2);
  }.bind(this));
};

/**
 * Introduction code
 */

var visual = new Visual(1000, 400);

var api = olinexpo(function () {
  // Loaded. Start rendering visual.
  setInterval(visual.render.bind(visual), 50);

  // Listen the current locations of all ants (listenAll with history == false).
  // This callback will be called every time a person changes position, where
  // the first argument is the guess where they are, the second argument is a list of 
  // all positions received by the client up until this point, and the third argument
  // is FALSE if the user has not been seen before (i.e. is a new user)
  api.listenAll(false, function (guess, guesses, isUpdate) {
    visual.resetMarkers();
    guesses.forEach(function (guess) {
      console.log('Segment with user+location:', guess.location, guess.user);
      var user = this.getUserById(guess.user); // user object
      visual.mark(guess.location, 5); 
    });
  });
});

    </script>
  </body>
</html>