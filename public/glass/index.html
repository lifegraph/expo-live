<!DOCTYPE html>

<html>
  <head>

<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <style>

html, body { margin: 0; padding: 0; background: #023; color: white; }
body { padding-top: 200px; background: url(expolive.png) 60px 0 no-repeat; background-color: transparent; }

html, body, table { height: 100%; width: 100%; margin: 0; padding: 0; border-collapse: collapse; }
td { vertical-align: middle; padding-top: 200px; }

#ac1 { background-image: url(ac1-white.png); margin-top: -400px; }
#ac3 { background-image: url(ac3-white.png); }

.building { width: 3000px; height: 1200px; overflow: auto; }
.center { margin-top: 600px; margin-left: 1500px; position: relative; }
.marker {
  -webkit-user-select: none;
  text-align: center;
  color: white;
  font-weight: bold;
  text-shadow: black 0 5px 5px;
  width: 0;
  height: 0;
  -webkit-transition-property: height, width, border-radius, margin-left, margin-top, line-height, font-size, color;
  -webkit-transition-duration: 1s, 1s, 1s, 1s, 1s, 1s, 1s, 10s;
}

    </style>
  </head>
  <body>
    <table><tr><td>

    <div id="ac3" class="building">
      <div class="center"></div>
    </div>

    <div id="ac1" class="building">
      <div class="center"></div>
    </div>

  </td></tr></table>

    <script src="http://code.jquery.com/jquery.js"></script>

<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/olinexpo.js"></script>
    <script>

/**
 * Automatically zoom screen.
 */

function fitScreen () {
  $('body').css('zoom', $(window).width()/3000*100 + '%'); 
}
$(window).on('resize', fitScreen);
fitScreen();


/**
 * Static mapping locations to graphical positions.
 * This needs to be fleshed out much more.
 */

var locations = {};

function Location (id, x, y) {
  this.baseSize = 50;

  this.id = id;
  this.x = x;
  this.y = y;

  this.$el = $('<div class="marker">').appendTo('#ac1 .center');
  this.$el.text(id.replace(/^AC[0-9]D/, ''));
  this.$el.css({ position: 'absolute', background: 'red' });
  this.$el.tooltip({
    title: id
  })

  this.position(x, y);
  this.size(this.baseSize);
  this.confidence(0.8);
  this.active(false);

  this.$el.on('click', function () {
    this.bump();
  }.bind(this))

  setInterval(function () {
    // TODO! This may make rooms not have presentations
    if (Date.now() - this._activetime > 60*1000*5) {
      this.active(false);
    }
    this.size(Math.max(this._size - 0.1, this.baseSize))
  }.bind(this), 100)
}

Location.prototype.size = function (size) {
  this._size = size;
  this.$el.css({
    width: size + 'px',
    height: size + 'px',
    lineHeight: size + 'px',
    borderRadius: (size / 2) + 'px',
    marginLeft: -size/2 + 'px',
    marginTop: -size/2 + 'px',
    fontSize: size / 3 + 'px'
  });
}

Location.prototype.position = function (x, y) {
  this.$el.css({
    top: y + 'px',
    left: x + 'px'
  })
}

Location.prototype.confidence = function (conf) {
  this._conf = conf || 1.0;
  this.$el.css({
    'background-color': (this._active ? 'rgba(255, 0, 0' : 'rgba(50, 60, 255') + ', ' + (this._conf || 1.0) + ')'
  });
}

Location.prototype.active = function (flag) {
  this._active = flag;
  this._activetime = Date.now();
  this.confidence(this._conf);
}

Location.prototype.bump = function (loc) {
  this.active(true);
  this.size(this._size + (200 - (this._size - this.baseSize)) / 4);
}


function createLocation (id, x, y) {
  locations[id] = new Location(id, x, y);
}

createLocation("AC118", -500, -80);

createLocation("AC1D1", 920, 80);
createLocation("AC1D2", 850, 30);
createLocation("AC1D3", 770, -10);
createLocation("AC1D4", 680, -40);
createLocation("AC1D5", 590, -70);
createLocation("AC1D6", 490, -100);
createLocation("AC1D7", 398, -112);
createLocation("AC1D8", -179, -96);
createLocation("AC1D9", -264, -88);
createLocation("AC1D10", -337, -71);
createLocation("AC1D11", -414, -48);
createLocation("AC1D12", -491, -25);
createLocation("AC1D13", -567, -2);
createLocation("AC1D14", -629, 34);
createLocation("AC1D15", -692, 64);
createLocation("AC1D16", -747, 94);
createLocation("AC1D17", -798, 121);
createLocation("AC1D18", -839, 148);
createLocation("AC1D19", -874, 170);
createLocation("AC1D20", -905, 191);

createLocation("AC1D5", 590, -70);
createLocation("AC1D6", 490, -100);
createLocation("AC1D7", 398, -112);
createLocation("AC1D8", 313, -120);

var api = olinexpo(function () {

  // Listen the current locations of all ants (listenAll with history == false).
  // This callback will be called every time a person changes position, where
  // the first argument is the guess where they are, the second argument is a list of 
  // all positions received by the client up until this point, and the third argument
  // is FALSE if the user has not been seen before (i.e. is a new user)
  api.listenAll(false, function (guess, guesses, isUpdate) {
    guesses.forEach(function (guess) {

      console.log(new Date());
      console.log('Guess for location:', guess.location, 'user:', guess.user);

      var location, user;
      if (location = locations[guess.location]) {
        if (user = api.getUserById(guess.user)) {
          console.log("I think that", user.name, "is at", guess.location);
          location.bump();
        }
      }
    });
  });
});

$('.building').on('dblclick', function (e) {
  var offset = $(this).offset();
  console.log(e.offsetX - $(this)[0].offsetWidth/2, e.offsetY - $(this)[0].offsetHeight/2);
  //document.body.innerHTML = '<h1>' + (e.offsetX - 1500) + 'x' + (e.offsetY - 600) + '</h1>'
})

    </script>
  </body>
</html>